<!DOCTYPE html>
<html>
<head>
    <title>1</title>
    <meta charset="utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="../static/bootstrap.min.css">

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>

    <script src="/webjars/stomp-websocket/2.3.3/stomp.min.js"></script>

    <style>
        #tagsUL > li:hover {
            background-color: #e6e6e6;
        }
    </style>

    <script>
        $( document ).ready(function () {
            connect();
            $('#sumaryTags').on('input', function(){ sendTag(this); });
            $(document).on('click', function(){ $('#tagsUL').addClass('invisible'); });
        });

        function connect() {
            socket = new SockJS('/gs-websocket');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                stompClient.subscribe('/user/queue/searchData', function(results) {
                    updateSearchResults(JSON.parse(results.body));
                });
                stompClient.subscribe('/user/queue/updateTags', function(results) {
                    updateTags(JSON.parse(results.body));
                });
            });
        }

        function updateTags(results) {
            $('#tagsUL').empty();

            $(results).each(function(i, result) {
                $('#tagsUL').append(
                    $('<li></li>')
                        .addClass('nav-item')
                        .on('click', function(){
                            textVal = $('#sumaryTags').val();
                            textVal = textVal.slice(0, textVal.length - getLastWord($('#sumaryTags')).length) + $(this).text();
                            $('#sumaryTags').val(textVal);
                            $('#tagsUL').addClass('invisible');
                        })
                        .text(result.message)
                );
            });

            $('#tagsUL').removeClass('invisible');
        }

        function updateSearchResults(results) {
            $(results).each(function(i, result) {
                console.log(result.message);
            });
        }

        function sendTag(elem) {
            stompClient.send("/app/tags/update", {}, JSON.stringify({'message' : getLastWord(elem)}));
        }

        function getLastWord(elem) {
            return  $(elem).val().slice(($(elem).val().lastIndexOf(" ")) + 1);
        }

        function sendData() {
            // spis = [];
            // spis.push("nameSummary" : $('#nameSummary').val());
            // spis.push($('#shortDescription').val());
            // spis.push($('#specialtyNumber').val());
            // spis.push($('#sumaryTags').val());
            // spis.push($('#textSummary').val());

            spis = {
                "nameSummary" : $('#nameSummary').val(),
                "shortDescription" : $('#shortDescription').val(),
                "specialtyNumber" : $('#specialtyNumber').val(),
                "sumaryTags" : $('#sumaryTags').val(),
                "textSummary" : $('#textSummary').val()
            };

            $.ajax({
                type: 'POST',
                dataType: 'json',
                contentType: 'application/json',
                url: '/main/addSummary',
                data: JSON.stringify(spis),
                success: function(data) {
                    alert(data);
                }
            });
        }

        function sendSearchData() {
            stompClient.send("/app/search/update", {}, JSON.stringify({'message' : $('#searchText').val()}));
        }
    </script>
</head>
<body>

<div class="m-2" style="width: 50%; height: 50%;">
    <div class="input-group mb-3">
        <input id="searchText" type="search"  class="form-control" placeholder="Recipient's username" aria-label="Recipient's username" aria-describedby="button-addon2">
        <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="button" id="button-addon2" onclick="sendSearchData()">Button</button>
        </div>
    </div>
</div>

<div class="mx-auto border p-4 mt-2" style="width: 50%; height: 50%;">
        <div class="form-group">
            <label for="nameSummary">Название</label>
            <input class="form-control has-error" id="nameSummary" type="text" placeholder="Введите название конспекта" required>
        </div>
        <div class="form-group">
            <label for="shortDescription">Краткое описание</label>
            <input class="form-control" id="shortDescription" type="text" placeholder="Краткое описание" required>
        </div>
        <div class="form-group">
            <label for="specialtyNumber">Номер специальности</label>
            <input class="form-control" id="specialtyNumber" type="text" placeholder="Номер специальности" required>
        </div>
        <div class="form-group position-relative">
            <label for="sumaryTags">Тэги</label>
            <input class="form-control" id="sumaryTags" type="text" placeholder="Тэги" required>
            <ul id="tagsUL" class="position-absolute border nav flex-column bg-light invisible" style="z-index: 999; width: 100%">
            </ul>
        </div>
        <div class="form-group">
            <label for="textSummary">Текст</label>
            <textarea class="form-control" id="textSummary" rows="10" required></textarea>
        </div>

        <button id="submit" class="btn btn-primary" onclick="sendData()">Submit</button>
</div>

</body>
</html>